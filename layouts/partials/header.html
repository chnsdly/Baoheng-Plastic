<header class="site-header" id="site-header">
  <nav class="navbar" aria-label="Primary">

    <div class="navbar__logo">
      <a href="{{ "/" | relLangURL }}">
        <img src='{{ (.Site.Params.logo | default "images/logo.png") | relURL }}' width="200" height="68"
          alt='{{ .Site.Params.company_name | default .Site.Title }}'>
      </a>
    </div>

    <nav class="navbar__menu" aria-label="Main navigation">
      {{ $current := . }}
      <ul>
        {{ range .Site.Menus.main }}
        {{ $active := or ($current.IsMenuCurrent "main" .) ($current.HasMenuCurrent "main" .) }}
        <li class="{{ if .HasChildren }}has-dropdown{{ end }}">
          <a href="{{ .URL | relLangURL }}" class="{{ if $active }}is-active{{ end }}">
            <span>{{ .Name }}</span>
            {{ if .HasChildren }}
            <svg class="dropdown-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
              aria-hidden="true">
              <path fill-rule="evenodd"
                d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z"
                clip-rule="evenodd" />
            </svg>
            {{ end }}
          </a>

          {{ if .HasChildren }}
          <ul class="dropdown-menu">
            {{ range .Children }}
            {{ $childActive := or ($current.IsMenuCurrent "main" .) ($current.HasMenuCurrent "main" .) }}
            <li>
              <a href="{{ .URL | relLangURL }}" class="{{ if $childActive }}is-active{{ end }}">{{ .Name }}</a>
            </li>
            {{ end }}
          </ul>
          {{ end }}
        </li>
        {{ end }}
      </ul>
    </nav>

    <div class="navbar__actions">
      {{ if hugo.IsMultilingual }}
      <div class="lang-switcher">
        <button class="lang-switcher__button">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5"
            stroke="currentColor" aria-hidden="true" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M2 12h20"></path>
            <path d="M12 2a15.75 15.75 0 0 1 0 20"></path>
            <path d="M12 2a15.75 15.75 0 0 0 0 20"></path>
          </svg>
          <span>{{ .Site.Language.LanguageName }}</span>
        </button>
        <div class="lang-switcher__dropdown">
          {{ $currentPage := . }}
          {{ $translations := $currentPage.AllTranslations }}
          {{ $homeTranslations := $.Site.Home.AllTranslations }}
          {{ $currentLang := $.Site.Language.Lang }}
          {{ range $.Site.Languages }}
          {{ if ne .Lang $currentLang }}
          {{ $lang := . }}
          {{ with (where $translations "Language.Lang" $lang.Lang) }}
          {{ $translatedPage := index . 0 }}
          <a href="{{ $translatedPage.RelPermalink }}">{{ $lang.LanguageName }}</a>
          {{ else }}
          {{ with (where $homeTranslations "Language.Lang" $lang.Lang) }}
          {{ $homePage := index . 0 }}
          <a href="{{ $homePage.RelPermalink }}">{{ $lang.LanguageName }}</a>
          {{ end }}
          {{ end }}
          {{ end }}
          {{ end }}
        </div>
      </div>
      {{ end }}

      <button class="navbar__toggler" id="drawer-toggler" aria-label="Open menu" aria-expanded="false"
        aria-controls="drawer">
        <span class="toggler-bar"></span>
        <span class="toggler-bar"></span>
        <span class="toggler-bar"></span>
      </button>
    </div>
  </nav>
</header>

<div class="drawer-overlay" id="drawer-overlay"></div>
<aside class="drawer" id="drawer">
  <div class="drawer__header">
    <span class="sr-only">Menu</span>
    <button class="drawer__close" data-close-drawer type="button" aria-label="Close menu">
      <span aria-hidden="true">✕</span>
    </button>
  </div>

  <nav class="drawer__menu" aria-label="Mobile navigation">
    {{ $current := . }}
    <ul>
      {{ range .Site.Menus.main }}
      {{ $active := or ($current.IsMenuCurrent "main" .) ($current.HasMenuCurrent "main" .) }}
      <li>
        {{ $submenuId := printf "submenu-%s" (urlize .Name) }}
        <div class="drawer__item">
          <a href="{{ .URL | relLangURL }}" class="{{ if $active }}is-active{{ end }}" data-drawer-link>{{ .Name }}</a>
          {{ if .HasChildren }}
          <button class="submenu-toggle" type="button" aria-expanded="false" aria-controls="{{ $submenuId }}"
            data-submenu-toggle data-submenu-target="{{ $submenuId }}">
            <span class="sr-only">Toggle {{ .Name }} submenu</span>
            <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd"
                d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z"
                clip-rule="evenodd" />
            </svg>
          </button>
          {{ end }}
        </div>
        {{ if .HasChildren }}
        <ul class="submenu" id="{{ $submenuId }}" hidden>
          {{ range .Children }}
          {{ $childActive := or ($current.IsMenuCurrent "main" .) ($current.HasMenuCurrent "main" .) }}
          <li><a href="{{ .URL | relLangURL }}" class="{{ if $childActive }}is-active{{ end }}" data-drawer-link>{{ .Name }}</a>
          </li>
          {{ end }}
        </ul>
        {{ end }}
      </li>
      {{ end }}
    </ul>
  </nav>

  {{ if hugo.IsMultilingual }}
  <div class="drawer__footer">
    <div class="lang-switcher">
      {{ $currentPage := . }}
      {{ $translations := $currentPage.AllTranslations }}
      {{ $homeTranslations := $.Site.Home.AllTranslations }}
      {{ range $.Site.Languages }}
      {{ $lang := . }}
      {{ if eq $lang.Lang $.Site.Language.Lang }}
      <a class="lang-switcher__button" href="{{ $currentPage.RelPermalink }}">{{ $lang.LanguageName }}</a>
      {{ else }}
      {{ with (where $translations "Language.Lang" $lang.Lang) }}
      {{ $translatedPage := index . 0 }}
      <a class="lang-switcher__button" href="{{ $translatedPage.RelPermalink }}">{{ $lang.LanguageName }}</a>
      {{ else }}
      {{ with (where $homeTranslations "Language.Lang" $lang.Lang) }}
      {{ $homePage := index . 0 }}
      <a class="lang-switcher__button" href="{{ $homePage.RelPermalink }}">{{ $lang.LanguageName }}</a>
      {{ end }}
      {{ end }}
      {{ end }}
      {{ end }}
    </div>
  </div>
  {{ end }}
</aside>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const header = document.getElementById('site-header');
    const body = document.body;
    const bodyHiddenClass = 'header-hidden';
    const drawer = document.getElementById('drawer');
    const drawerToggler = document.getElementById('drawer-toggler');
    const drawerOverlay = document.getElementById('drawer-overlay');
    const drawerLinks = drawer ? drawer.querySelectorAll('[data-drawer-link]') : [];
    const drawerCloseButtons = document.querySelectorAll('[data-close-drawer]');
    const submenuToggles = drawer ? drawer.querySelectorAll('[data-submenu-toggle]') : [];
    let previousFocus = null;

    // --- 1. 智能导航栏 (Smart Header) 逻辑 ---
    if (header) {
      let lastScrollY = window.scrollY;     // 上一次滚动位置
      const scrollThreshold = 72;         // 超过导航栏高度后才开始隐藏/显示
      const scrollDelta = 5;             // 滚动变化小于 5px 时不处理，防止抖动

      function handleSmartHeader() {
        const currentScrollY = window.scrollY;

        // 1. 处理 'is-scrolled' 样式 (背景/阴影变化)
        if (currentScrollY > 10) header.classList.add('is-scrolled');
        else header.classList.remove('is-scrolled');

        // 2. 处理 'is-hidden' 样式 (隐藏/显示)
        // 在页面顶部时，始终显示导航栏
        if (currentScrollY <= scrollThreshold) {
          header.classList.remove('is-hidden');
          body.classList.remove(bodyHiddenClass);
          lastScrollY = currentScrollY;
          return;
        }

        // 滚动变化不大时忽略
        if (Math.abs(lastScrollY - currentScrollY) < scrollDelta) {
          return;
        }

        // 向上滚动 (显示)
        if (currentScrollY < lastScrollY) {
          header.classList.remove('is-hidden');
          body.classList.remove(bodyHiddenClass);
        }
        // 向下滚动 (隐藏)
        else if (currentScrollY > lastScrollY) {
          header.classList.add('is-hidden');
          body.classList.add(bodyHiddenClass);
        }

        // 更新上一次滚动位置
        lastScrollY = currentScrollY;
      }

      // 使用 requestAnimationFrame 优化滚动性能
      let ticking = false;
      window.addEventListener('scroll', () => {
        if (!ticking) {
          window.requestAnimationFrame(() => {
            handleSmartHeader();
            ticking = false;
          });
          ticking = true;
        }
      });

      // 页面加载时执行一次
      handleSmartHeader();
    }

    // --- 2. 抽屉 (Drawer) 逻辑 ---
    const toggleAria = (isOpen) => {
      if (drawerToggler) drawerToggler.setAttribute('aria-expanded', String(isOpen));
      if (drawer) drawer.setAttribute('aria-hidden', String(!isOpen));
    };

    const focusableSelector = 'a[href], button:not([disabled]), input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])';

    const trapFocus = (event) => {
      if (body.getAttribute('data-drawer-open') !== 'true' || !drawer) return;
      const focusable = Array.from(drawer.querySelectorAll(focusableSelector)).filter(el => el.offsetParent !== null);
      if (focusable.length === 0) return;

      const first = focusable[0];
      const last = focusable[focusable.length - 1];

      if (event.key === 'Tab') {
        if (event.shiftKey && document.activeElement === first) {
          event.preventDefault();
          last.focus();
        } else if (!event.shiftKey && document.activeElement === last) {
          event.preventDefault();
          first.focus();
        }
      }
    };

    const openDrawer = () => {
      body.setAttribute('data-drawer-open', 'true');
      if (drawerToggler) drawerToggler.classList.add('open');
      toggleAria(true);
      previousFocus = document.activeElement;
      const focusTarget = drawer.querySelector('[data-close-drawer]') || drawer.querySelector(focusableSelector);
      focusTarget?.focus({ preventScroll: true });
      document.addEventListener('keydown', trapFocus);
    };

    const closeDrawer = () => {
      body.setAttribute('data-drawer-open', 'false');
      if (drawerToggler) drawerToggler.classList.remove('open');
      toggleAria(false);
      document.removeEventListener('keydown', trapFocus);
      if (previousFocus && typeof previousFocus.focus === 'function') {
        previousFocus.focus({ preventScroll: true });
      }
      // 收起所有子菜单，避免下一次打开时状态错乱
      submenuToggles.forEach(toggle => {
        const targetId = toggle.dataset.submenuTarget;
        const submenu = targetId ? document.getElementById(targetId) : null;
        toggle.setAttribute('aria-expanded', 'false');
        toggle.closest('li')?.classList.remove('is-open');
        if (submenu) submenu.hidden = true;
      });
    };

    if (drawerToggler) {
      drawerToggler.addEventListener('click', () => {
        const isOpen = body.getAttribute('data-drawer-open') === 'true';
        if (isOpen) {
          closeDrawer();
        } else {
          openDrawer();
        }
      });
    }

    if (drawerOverlay) {
      drawerOverlay.addEventListener('click', closeDrawer);
    }

    drawerCloseButtons.forEach(button => button.addEventListener('click', closeDrawer));

    drawerLinks.forEach(link => link.addEventListener('click', closeDrawer));

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && body.getAttribute('data-drawer-open') === 'true') {
        closeDrawer();
      }
    });

    // 在桌面尺寸切换时自动关闭抽屉，避免状态错位
    const desktopQuery = window.matchMedia('(min-width: 1024px)');
    desktopQuery.addEventListener('change', (event) => {
      if (event.matches) {
        closeDrawer();
      }
    });

    // --- 3. 子菜单折叠 (移动端) ---
    submenuToggles.forEach(toggle => {
      toggle.addEventListener('click', () => {
        const targetId = toggle.dataset.submenuTarget;
        if (!targetId) return;
        const submenu = document.getElementById(targetId);
        const listItem = toggle.closest('li');
        const isOpen = toggle.getAttribute('aria-expanded') === 'true';

        // 只允许一个子菜单展开，避免滚动高度不可控
        submenuToggles.forEach(btn => {
          const siblingId = btn.dataset.submenuTarget;
          const siblingMenu = siblingId ? document.getElementById(siblingId) : null;
          btn.setAttribute('aria-expanded', 'false');
          btn.closest('li')?.classList.remove('is-open');
          if (siblingMenu) siblingMenu.hidden = true;
        });

        if (!isOpen && submenu && listItem) {
          toggle.setAttribute('aria-expanded', 'true');
          submenu.hidden = false;
          listItem.classList.add('is-open');
        }
      });
    });
  });
</script>