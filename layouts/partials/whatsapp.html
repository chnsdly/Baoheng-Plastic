{{/*
  WhatsApp Icon-only FAB (no messageTpl) — responsive sizes
  - 不预填任何文本；仅打开 wa.me/PHONE
  - 手机端按钮更大；可切换左右；支持安全边距
  - 轻量埋点可保留/删除
*/}}

{{- $cfg := .Site.Params.whatsapp -}}
{{- if and $cfg ($cfg.enabled | default true) -}}
  {{- $phone := $cfg.phone | default "" -}}
  {{- if ne $phone "" -}}
    {{- $label := $cfg.label | default "Chat on WhatsApp" -}}
    {{- $href := printf "https://wa.me/%s" $phone -}}

    {{- $side := $cfg.side | default "right" -}}
    {{- $sizeDesktop := $cfg.sizeDesktop | default 60 -}}
    {{- $sizeMobile  := $cfg.sizeMobile  | default 72 -}}
    {{- $offsetDesktop := $cfg.offsetDesktop | default 18 -}}
    {{- $offsetMobile  := $cfg.offsetMobile  | default 14 -}}

    <div class="wa-fab"
         data-wa
         data-side="{{ $side }}"
         style="--wa-size-desktop: {{ $sizeDesktop }}px; --wa-size-mobile: {{ $sizeMobile }}px; --wa-offset-desktop: {{ $offsetDesktop }}px; --wa-offset-mobile: {{ $offsetMobile }}px;"
         data-wa-href="{{ $href }}">
      <a class="wa-fab__btn" href="{{ $href }}" target="_blank" rel="noopener"
         aria-label="{{ $label }}" title="{{ $label }}">
        <img class="wa-fab__icon" src="{{ "images/icons/whatsapp.svg" | relURL }}" alt="" aria-hidden="true" loading="lazy" decoding="async" />
      </a>
    </div>

    <style>
      .wa-fab { position: fixed; bottom: var(--wa-offset-desktop); z-index: 9999; }
      .wa-fab[data-side="right"] { right: var(--wa-offset-desktop); }
      .wa-fab[data-side="left"]  { left:  var(--wa-offset-desktop); }

      /* 按钮与图标尺寸（桌面默认） */
      .wa-fab__btn {
        width: var(--wa-size-desktop);
        height: var(--wa-size-desktop);
        display: inline-flex; align-items: center; justify-content: center;
        background: #25D366; color: #fff; text-decoration: none;
        border-radius: 50%; box-shadow: 0 8px 20px rgba(0,0,0,.15);
        outline: none; transition: transform .15s ease, background .15s ease, box-shadow .15s ease;
      }
      .wa-fab__icon {
        display: block;
        width:  calc(var(--wa-size-desktop) * 0.56);
        height: calc(var(--wa-size-desktop) * 0.56);
      }

      .wa-fab__btn:hover { background: #1faa56; transform: translateY(-1px); box-shadow: 0 10px 22px rgba(0,0,0,.18); }
      .wa-fab__btn:active { transform: translateY(0); box-shadow: 0 6px 16px rgba(0,0,0,.14); }
      .wa-fab__btn:focus-visible { box-shadow: 0 0 0 3px rgba(37,211,102,.35), 0 8px 20px rgba(0,0,0,.15); }

      /* 安全区适配 */
      @supports (padding: max(0px)) {
        .wa-fab[data-side="right"] { right: max(var(--wa-offset-desktop), env(safe-area-inset-right)); }
        .wa-fab[data-side="left"]  { left:  max(var(--wa-offset-desktop), env(safe-area-inset-left)); }
        .wa-fab { bottom: max(var(--wa-offset-desktop), env(safe-area-inset-bottom)); }
      }

      /* 手机端：更大按钮、更紧边距 */
      @media (max-width: 420px) {
        .wa-fab { bottom: var(--wa-offset-mobile); }
        .wa-fab[data-side="right"] { right: var(--wa-offset-mobile); }
        .wa-fab[data-side="left"]  { left:  var(--wa-offset-mobile); }

        @supports (padding: max(0px)) {
          .wa-fab[data-side="right"] { right: max(var(--wa-offset-mobile), env(safe-area-inset-right)); }
          .wa-fab[data-side="left"]  { left:  max(var(--wa-offset-mobile), env(safe-area-inset-left)); }
          .wa-fab { bottom: max(var(--wa-offset-mobile), env(safe-area-inset-bottom)); }
        }

        .wa-fab__btn {
          width: var(--wa-size-mobile);
          height: var(--wa-size-mobile);
        }
        .wa-fab__icon {
          width:  calc(var(--wa-size-mobile) * 0.56);
          height: calc(var(--wa-size-mobile) * 0.56);
        }
      }
    </style>

    <script>
      (function(){
        var root = document.querySelector('[data-wa]');
        if(!root) return;
        var a = root.querySelector('.wa-fab__btn');
        var baseHref = root.getAttribute('data-wa-href');

        a.addEventListener('click', function(){
          try{
            var url = new URL(baseHref);
            url.searchParams.delete('text'); // 保证不带任何预填文本
            a.setAttribute('href', url.toString());
          }catch(e){}
          // 轻量埋点（可删除）
          try{ window.dataLayer = window.dataLayer || []; window.dataLayer.push({event:'WhatsAppOpen', placement:'fab'}); }catch(e){}
          try{ if(window.gtag) window.gtag('event','WhatsAppOpen',{placement:'fab'}); }catch(e){}
          try{ if(window.fbq) window.fbq('trackCustom','WhatsAppOpen',{placement:'fab'}); }catch(e){}
        });
      })();
    </script>
  {{- end -}}
{{- end -}}
