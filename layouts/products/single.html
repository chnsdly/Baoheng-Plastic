
{{ define "main" }}
  {{ $allProducts := .Site.RegularPages }}
  {{ $productMenus := slice }}
  {{ $sidebarToggleLabel := cond (eq $.Site.Language.Lang "zh") "浏览产品分类" "Browse categories" }}
  {{ with where .Site.Menus.main "Identifier" "products" }}
    {{ with index . 0 }}
      {{ $productMenus = sort .Children "Weight" }}
    {{ end }}
  {{ end }}

  <section class="product-single">
    <div class="container product-single__container">
      <aside class="product-sidebar" aria-label='{{ i18n "product_categories" | default "Product categories" }}'>
        <div class="product-sidebar__header">
          <h2 class="product-sidebar__title">{{ i18n "product_menu" | default "Products" }}</h2>
          <button class="product-sidebar__toggle" type="button" aria-expanded="false" aria-controls="product-sidebar-panel">{{ $sidebarToggleLabel }}<span class="product-sidebar__toggle-icon" aria-hidden="true"></span></button>
        </div>
        <div class="product-sidebar__panel" id="product-sidebar-panel">
          <ul class="product-sidebar__list" role="list">
            {{ range $productMenus }}
              {{ $menuName := .Name }}
              {{ $matchingPages := where $allProducts "Params.product_type" $menuName }}
              {{ $categories := slice }}
              {{ range $matchingPages }}
                {{ with .Params.pallet_category }}
                  {{ $catVal := . }}
                  {{ if eq (printf "%T" $catVal) "string" }}
                    {{ $categories = $categories | append $catVal }}
                  {{ else }}
                    {{ range $catVal }}
                      {{ $categories = $categories | append . }}
                    {{ end }}
                  {{ end }}
                {{ end }}
              {{ end }}
              {{ $categories = uniq (sort $categories) }}
              {{ $hasChildren := gt (len $categories) 0 }}
              {{ $menuURL := .URL | relLangURL }}
              {{ $isActive := hasPrefix $.RelPermalink $menuURL | or (eq $.Params.product_type $menuName) }}
              <li class="product-sidebar__item{{ if $hasChildren }} product-sidebar__item--has-children{{ end }}{{ if $isActive }} product-sidebar__item--current{{ end }}">
                <a class="product-sidebar__link" href="{{ $menuURL }}">{{ $menuName }}</a>
                {{ if $hasChildren }}
                  <ul class="product-sidebar__submenu" role="list">
                    {{ range $categories }}
                      <li class="product-sidebar__subitem">
                        {{ $categoryParam := urlquery . }}
                        <a class="product-sidebar__sublink" data-category="{{ . }}" href="{{ printf "%s?category=%s" $menuURL $categoryParam }}">{{ . }}</a>
                      </li>
                    {{ end }}
                  </ul>
                {{ end }}
              </li>
            {{ end }}
          </ul>
        </div>
      </aside>

      <article class="product-single__content">
        {{ $contactPage := site.GetPage (printf "/%s/contact" .Site.Language.Lang) }}
        {{ $contactURL := cond $contactPage $contactPage.RelPermalink (relLangURL "/contact") }}
        {{ $heroText := .Params.hero_description | default .Params.summary }}
        {{ $detailHeading := .Params.detail_heading | default (i18n "product_detail_heading" | default "产品详情") }}
        {{ $detailIntro := .Params.detail_intro | default .Params.detail_description }}
        {{ $ctaLabel := .Params.contact_cta_label | default (i18n "cta_get_quote" | default "Get a quote") }}
        {{ $ctaHref := .Params.contact_cta_link | default $contactURL }}
        {{ $socials := site.Params.social }}
        {{ $industryGallery := .Params.industry_gallery | default .Params.detail_gallery }}
        {{ $showcaseGallery := .Params.showcase_gallery | default $industryGallery }}

        <header class="product-single__header">
          <h1 class="product-single__title">{{ .Title }}</h1>
        </header>

        <div class="product-overview">
          <figure class="product-overview__media">
            {{ if .Params.featured_image_asset }}
              {{ partial "picture.html" (dict
                "ctx" .
                "src" .Params.featured_image_asset
                "alt" .Title
                "w" (slice 640 960 1440)
                "sizes" "(max-width: 64rem) 100vw, 60%"
                "class" "product-overview__image"
                "fetch" ""
              ) }}
            {{ else }}
              <img class="product-overview__image" src='{{ .Params.featured_image | default "/images/placeholder.jpg" | relURL }}' alt='{{ .Title }}'>
            {{ end }}
          </figure>

          <div class="product-overview__body">
            {{ with $heroText }}
              <p class="product-overview__description">{{ . }}</p>
            {{ end }}

            <div class="product-overview__actions">
              <a class="button button--primary product-overview__cta" href="{{ $ctaHref }}">{{ $ctaLabel }}</a>

              <div class="product-overview__socials" aria-label="{{ i18n "share" | default "Share" }}">
                  {{ with $socials.linkedin }}
                    <a class="product-overview__social" aria-label="LinkedIn" href="{{ . }}" target="_blank" rel="noreferrer noopener">
                      <img class="product-overview__social-icon" src='{{ "images/icons/linkedin.svg" | relURL }}' alt="LinkedIn" width="24" height="24">
                    </a>
                  {{ end }}
                  {{ with $socials.twitter }}
                    <a class="product-overview__social" aria-label="X (Twitter)" href="{{ . }}" target="_blank" rel="noreferrer noopener">
                      <img class="product-overview__social-icon" src='{{ "images/icons/x.svg" | relURL }}' alt="X (Twitter)" width="24" height="24">
                    </a>
                  {{ end }}
                  {{ with $socials.youtube }}
                    <a class="product-overview__social" aria-label="YouTube" href="{{ . }}" target="_blank" rel="noreferrer noopener">
                      <img class="product-overview__social-icon" src='{{ "images/icons/youtube.svg" | relURL }}' alt="YouTube" width="24" height="24">
                    </a>
                  {{ end }}
                  {{ with $socials.facebook }}
                    <a class="product-overview__social" aria-label="Facebook" href="{{ . }}" target="_blank" rel="noreferrer noopener">
                      <img class="product-overview__social-icon" src='{{ "images/icons/facebook.svg" | relURL }}' alt="Facebook" width="24" height="24">
                    </a>
                  {{ end }}
                </div>
            </div>
          </div>
        </div>

        <section class="product-details" aria-labelledby="product-details-heading">
          <div class="product-details__header">
            <h2 class="product-details__title" id="product-details-heading">{{ $detailHeading }}</h2>
            {{ with $detailIntro }}
              <div class="product-details__intro">
                {{ . | markdownify }}
              </div>
            {{ end }}
          </div>

          {{ with .Params.product_showcase }}
            {{ if and .enable .items }}
              {{ $productShowcaseTitle := .title | default (i18n "product_gallery" | default "Product gallery") }}
              <section class="product-showcase-grid" aria-labelledby="product-showcase-title">
                <header class="product-showcase-grid__header">
                  <h3 id="product-showcase-title" class="product-showcase-grid__title">{{ $productShowcaseTitle }}</h3>
                  {{ with .description }}
                    <p class="product-showcase-grid__description">{{ . }}</p>
                  {{ end }}
                </header>
                <div class="product-showcase-grid__list" role="list">
                  {{ range .items }}
                    {{ $asset := .image_asset | default .image | default .imag }}
                    {{ if $asset }}
                      <figure class="product-showcase-grid__item" role="listitem">
                        {{ partial "picture.html" (dict
                          "ctx" $ 
                          "src" $asset 
                          "alt" (.alt | default $.Title) 
                          "w" (slice 320 480 640 768 960) 
                          "sizes" "(max-width: 48rem) 100vw, 33vw" 
                          "class" "product-showcase-grid__image" 
                          "fetch" ""
                        ) }}
                        {{ with .title }}
                          <figcaption class="product-showcase-grid__caption">{{ . }}</figcaption>
                        {{ end }}
                      </figure>
                    {{ end }}
                  {{ end }}
                </div>
              </section>
            {{ end }}
          {{ end }}

          {{ with $showcaseGallery }}
            {{ $showcaseItems := first 4 . }}
            <div class="showcase__gallery" aria-label="{{ i18n "product_gallery" | default "Product gallery" }}">
              {{ range $showcaseItems }}
                {{ $asset := .image_asset | default .image }}
                {{ if $asset }}
                  <figure class="showcase__figure">
                    {{ partial "picture.html" (dict "ctx" $ "src" $asset "alt" (.alt | default $.Title) "w" (slice 640 960 1440) "sizes" "(max-width: 64rem) 100vw, 50vw" "class" "showcase__image" "fetch" "") }}
                  </figure>
                {{ end }}
              {{ end }}
            </div>
          {{ end }}

          {{ if .Params.specs }}
            <div class="product-details__specs">
              {{ partial "product-specs.html" . }}
            </div>
          {{ end }}

          {{ with $industryGallery }}
            {{ $galleryItems := first 3 . }}
            {{ $primary := index $galleryItems 0 }}
            <div class="industry-gallery" aria-label="{{ i18n "product_gallery" | default "Product gallery" }}">
              <div class="industry-gallery__gallery">
                {{ with $primary }}
                  {{ $asset := .image_asset | default .image }}
                  {{ if $asset }}
                    <figure class="industry-gallery__figure industry-gallery__figure--primary">
                      {{ partial "picture.html" (dict "ctx" $ "src" $asset "alt" (.alt | default $.Title) "w" (slice 640 960 1440) "sizes" "(max-width: 64rem) 100vw, 60vw" "class" "industry-gallery__image" "fetch" "") }}
                    </figure>
                  {{ end }}
                {{ end }}

                <div class="industry-gallery__stack">
                  {{ range after 1 $galleryItems }}
                    {{ $asset := .image_asset | default .image }}
                    {{ if $asset }}
                      <figure class="industry-gallery__figure industry-gallery__figure--secondary">
                        {{ partial "picture.html" (dict "ctx" $ "src" $asset "alt" (.alt | default $.Title) "w" (slice 640 960 1440) "sizes" "(max-width: 64rem) 100vw, 40vw" "class" "industry-gallery__image" "fetch" "") }}
                      </figure>
                    {{ end }}
                  {{ end }}
                </div>
              </div>
            </div>
          {{ end }}

          <div class="product-details__form">
            {{ with .Params.form_title }}<h3 class="product-details__form-title">{{ . }}</h3>{{ end }}
            {{ with .Params.form_description }}<p class="product-details__form-description">{{ . }}</p>{{ end }}
            {{ partial "lead-form.html" (dict "type" "product-detail" "slug" .File.ContentBaseName "page" . "sitekey" .Site.Params.turnstile_site_key) }}
          </div>
        </section>
      </article>
    </div>
  </section>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const params = new URLSearchParams(window.location.search);
      const activeCategory = params.get('category') || '';
      const cards = document.querySelectorAll('.product-listing__card');
      const links = document.querySelectorAll('.product-sidebar__sublink');
      const pager = document.querySelector('.product-listing__pager');
      const sidebar = document.querySelector('.product-sidebar');
      const sidebarToggle = document.querySelector('.product-sidebar__toggle');
      const sidebarPanel = document.querySelector('.product-sidebar__panel');
      const desktopQuery = window.matchMedia('(min-width: 48rem)');

      const toggleCards = (category) => {
        cards.forEach((card) => {
          const list = (card.dataset.categories || '').split('|').filter(Boolean);
          const defaultVisible = card.dataset.defaultVisible === 'true';
          const matches = category ? list.includes(category) : defaultVisible;
          card.style.display = matches ? '' : 'none';
        });

        links.forEach((link) => {
          const isActive = category && link.dataset.category === category;
          link.classList.toggle('product-sidebar__sublink--active', isActive);
          if (isActive) {
            link.setAttribute('aria-current', 'true');
          } else {
            link.removeAttribute('aria-current');
          }
        });
        if (pager) {
          pager.style.display = category ? 'none' : '';
        }
      };

      links.forEach((link) => {
        link.addEventListener('click', (event) => {
          const category = link.dataset.category || '';
          const linkUrl = new URL(link.href, window.location.origin);

          if (linkUrl.pathname !== window.location.pathname) {
            return;
          }

          event.preventDefault();
          const url = new URL(window.location.href);

          if (category) {
            url.searchParams.set('category', category);
          } else {
            url.searchParams.delete('category');
          }

          window.history.replaceState({}, '', url.toString());
          toggleCards(category);
        });
      });

      toggleCards(activeCategory);

      const syncSidebarState = () => {
        if (!sidebar || !sidebarToggle || !sidebarPanel) return;
        const isDesktop = desktopQuery.matches;
        const shouldBeOpen = isDesktop || sidebar.classList.contains('is-open');

        sidebar.classList.toggle('is-open', shouldBeOpen);
        sidebarToggle.setAttribute('aria-expanded', shouldBeOpen ? 'true' : 'false');
        sidebarPanel.hidden = !shouldBeOpen && !isDesktop;
      };

      if (sidebar && sidebarToggle && sidebarPanel) {
        sidebar.classList.toggle('is-open', desktopQuery.matches);
        syncSidebarState();

        sidebarToggle.addEventListener('click', () => {
          sidebar.classList.toggle('is-open');
          syncSidebarState();
        });

        desktopQuery.addEventListener('change', () => {
          sidebar.classList.toggle('is-open', desktopQuery.matches);
          syncSidebarState();
        });
      }
    });
  </script>
{{ end }}
